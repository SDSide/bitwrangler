#include <SFML/Graphics.hpp>
#include <array>
#include <vector>
#include <cstdint>
#include <fstream>
#include <iostream>

struct Color {
    uint8_t r, g, b; // refactoring begins oh god
};


void setpixel(unsigned x, unsigned y,
              std::vector<uint8_t>& framebuffer,
              unsigned width,
              uint8_t colorIndex)
{
    if (colorIndex != 0) {
        framebuffer[y * width + x] = colorIndex;
    }
}

void renderquad(unsigned x0, unsigned y0,
                std::vector<uint8_t>& framebuffer,
                unsigned rectW,
                unsigned rectH,
                unsigned fbW,
                unsigned fbH,
                uint8_t colorIndex)
{
    for (unsigned y = y0; y < y0 + rectH; ++y) {
        for (unsigned x = x0; x < x0 + rectW; ++x) {
            if (x < fbW && y < fbH)
                setpixel(x, y, framebuffer, fbW, colorIndex);
        }
    }
}



int main() {

    // boilerplate window size shit. i really should pick a widescreen resolution.
    const unsigned width = 320;
    const unsigned height = 240;

    // 640*360 should be adequate for most displays. maybe ill make a 480*360 mode for 4:3 compat.
    // const unsigned width = 640, height = 360;

    sf::RenderWindow window(sf::VideoMode({width, height}), "bitwrangler window", sf::Style::Default);
    window.setVerticalSyncEnabled(true);

    // -----------------------------
    // IDK WHY I SAID TS WAS AN ARRAY IT WAS A VECTOR
    // this is js 1 byte per pixel instead of 4
    // js an array filled with structs :sob: this is likely insanely inefficient
    // -----------------------------
    std::array<Color, 256> palette = {{
        {0xff,0x00,0xff},{0x5d,0x03,0x03},{0x93,0x02,0x02},{0xc9,0x01,0x01},
        {0xff,0x00,0x00},{0xff,0x40,0x40},{0xff,0x7f,0x7f},{0xff,0xbf,0xbf},
        {0x40,0x16,0x1e},{0x5f,0x20,0x2c},{0x81,0x2a,0x3c},{0xa4,0x35,0x4b},
        {0xb8,0x4e,0x63},{0xc4,0x73,0x83},{0xd1,0x9b,0xa6},{0xdc,0xbf,0xc5},
        {0x49,0x33,0x09},{0x77,0x4f,0x07},{0xa6,0x6b,0x05},{0xd3,0x87,0x02},
        {0xff,0xa2,0x00},{0xff,0xb7,0x41},{0xfe,0xcc,0x82},{0xfe,0xe3,0xc3},
        {0x3a,0x2b,0x13},{0x60,0x45,0x1a},{0x85,0x5e,0x21},{0xab,0x77,0x27},
        {0xd1,0x90,0x2e},{0xdc,0xac,0x64},{0xe7,0xc8,0x99},{0xf3,0xe5,0xcf},
        {0x42,0x4b,0x03},{0x67,0x77,0x00},{0x8d,0xa3,0x00},{0xb2,0xcf,0x00},
        {0xd8,0xfb,0x00},{0xe1,0xfc,0x43},{0xeb,0xfc,0x8d},{0xf6,0xfc,0xd7},
        {0x3e,0x46,0x1a},{0x5c,0x68,0x20},{0x7b,0x8c,0x24},{0x98,0xaf,0x29},
        {0xb6,0xd1,0x2e},{0xca,0xdd,0x67},{0xdc,0xe8,0x9f},{0xf0,0xf4,0xd9},
        {0x1c,0x46,0x01},{0x30,0x75,0x00},{0x44,0xa4,0x00},{0x57,0xd2,0x00},
        {0x6c,0xff,0x00},{0x8d,0xff,0x45},{0xb1,0xff,0x86},{0xd8,0xfe,0xc6},
        {0x06,0x26,0x00},{0x28,0x4c,0x21},{0x49,0x72,0x41},{0x6b,0x98,0x62},
        {0x8c,0xbe,0x82},{0xa3,0xd3,0x9a},{0xbb,0xe8,0xb2},{0xd2,0xfd,0xca},
        {0x00,0x42,0x19},{0x00,0x71,0x2d},{0x00,0xa1,0x43},{0x00,0xd1,0x57},
        {0x01,0xff,0x6c},{0x42,0xff,0x8c},{0x81,0xff,0xaf},{0xbf,0xff,0xd4},
        {0x00,0x43,0x21},{0x1d,0x61,0x3f},{0x3b,0x7f,0x5c},{0x58,0x9c,0x7a},
        {0x75,0xba,0x97},{0x91,0xca,0xad},{0xad,0xda,0xc4},{0xc9,0xea,0xda},
        {0x00,0x2e,0x2c},{0x00,0x4e,0x4d},{0x02,0x75,0x76},{0x10,0x9c,0xa0},
        {0x25,0xc5,0xc9},{0x51,0xce,0xd4},{0x7a,0xdc,0xe5},{0x8b,0xe4,0xee},
        {0x00,0x27,0x20},{0x0e,0x42,0x39},{0x1b,0x5d,0x52},{0x29,0x78,0x6a},
        {0x36,0x93,0x83},{0x58,0xa8,0x9a},{0x7b,0xbd,0xb2},{0x9d,0xd2,0xc9},
        {0x00,0x08,0x1d},{0x00,0x11,0x35},{0x00,0x2c,0x6c},{0x00,0x4b,0xa6},
        {0x00,0x69,0xde},{0x1e,0x80,0xec},{0x6a,0xac,0xf7},{0xaa,0xcd,0xf4},
        {0x00,0x25,0x2f},{0x00,0x4e,0x63},{0x00,0x76,0x97},{0x00,0xa0,0xcb},
        {0x00,0xc8,0xff},{0x3f,0xd5,0xfe},{0x7f,0xe3,0xfe},{0xbe,0xf0,0xfd},
        {0x00,0x00,0x16},{0x00,0x00,0x23},{0x00,0x00,0x5b},{0x00,0x00,0x8e},
        {0x00,0x00,0xc3},{0x1d,0x1d,0xe2},{0x75,0x75,0xff},{0xa3,0xa3,0xff},
        {0x0b,0x19,0x2d},{0x14,0x2f,0x55},{0x1d,0x45,0x7d},{0x27,0x5c,0xa4},
        {0x30,0x72,0xcc},{0x57,0x8c,0xd6},{0x7f,0xa8,0xdf},{0xa7,0xc3,0xe8},
        {0x31,0x09,0x35},{0x5f,0x11,0x5f},{0x86,0x18,0x81},{0xad,0x1e,0xa2},
        {0xd6,0x23,0xc7},{0xdc,0x24,0xda},{0xe1,0x67,0xec},{0xdd,0xa3,0xf1},
        {0x26,0x1b,0x2a},{0x3e,0x28,0x47},{0x56,0x36,0x65},{0x6f,0x43,0x82},
        {0x88,0x50,0xa0},{0x93,0x62,0xa4},{0xa5,0x85,0xb1},{0xb6,0xa7,0xbc},
        {0x1f,0x1c,0x1c},{0x2e,0x20,0x20},{0x40,0x29,0x28},{0x59,0x37,0x36},
        {0x7a,0x4f,0x4d},{0x95,0x72,0x71},{0xb4,0x9c,0x9a},{0xca,0xba,0xb9},
        {0x4e,0x4d,0x47},{0x70,0x6c,0x55},{0x91,0x8b,0x64},{0xb3,0xa9,0x72},
        {0xd4,0xc8,0x80},{0xdf,0xd5,0x9c},{0xe9,0xe3,0xb8},{0xf4,0xf0,0xd4},
        {0x26,0x3e,0x45},{0x36,0x4c,0x53},{0x46,0x5a,0x61},{0x55,0x68,0x6f},
        {0x65,0x77,0x7d},{0x80,0x90,0x96},{0x9b,0xaa,0xaf},{0xb6,0xc4,0xc8},
        {0x39,0x27,0x0f},{0x4d,0x3b,0x23},{0x62,0x50,0x38},{0x76,0x64,0x4c},
        {0x8a,0x78,0x60},{0xa1,0x90,0x7a},{0xb8,0xa9,0x94},{0xcf,0xc1,0xae},
        {0x3e,0x11,0x09},{0x56,0x1d,0x06},{0x78,0x2d,0x03},{0x9f,0x40,0x02},
        {0xbd,0x50,0x03},{0xd3,0x5b,0x00},{0xec,0x7a,0x2a},{0xff,0x8f,0x3b},
        {0x00,0x15,0x2f},{0x12,0x26,0x3f},{0x25,0x37,0x4f},{0x37,0x48,0x5e},
        {0x49,0x59,0x6e},{0x69,0x77,0x8b},{0x88,0x96,0xa7},{0xa8,0xb4,0xc4},
        {0x3f,0x00,0x00},{0x5b,0x00,0x00},{0x73,0x00,0x00},{0x9e,0x00,0x00},
        {0xaa,0x00,0x00},{0xba,0x15,0x15},{0xd7,0x2c,0x2c},{0xe3,0x33,0x33},
        {0x18,0x20,0x15},{0x23,0x2e,0x1e},{0x2e,0x3f,0x28},{0x3b,0x50,0x33},
        {0x47,0x5e,0x3e},{0x52,0x6b,0x4b},{0x5e,0x7a,0x5a},{0x68,0x85,0x65},
        {0x23,0x0d,0x00},{0x2e,0x12,0x00},{0x4c,0x1d,0x00},{0x71,0x2a,0x00},
        {0x87,0x40,0x16},{0x9d,0x58,0x2e},{0xb2,0x6f,0x47},{0xc8,0x87,0x5f},
        {0xdd,0x9c,0x75},{0xeb,0xaf,0x8b},{0xf2,0xbf,0xa0},{0xf8,0xcd,0xb3},
        {0xfe,0xdb,0xc5},{0xff,0xe7,0xd7},{0xff,0xf2,0xea},{0xff,0xf7,0xf1},
        {0x0f,0x12,0x27},{0x1b,0x1e,0x31},{0x27,0x2a,0x3d},{0x36,0x38,0x4a},
        {0x42,0x44,0x55},{0x51,0x53,0x62},{0x5f,0x61,0x6e},{0x6e,0x70,0x7d},
        {0x7e,0x80,0x8b},{0x8e,0x8f,0x9a},{0x9f,0x9f,0xa8},{0xaf,0xb0,0xb7},
        {0xbe,0xbf,0xc4},{0xcd,0xcd,0xd2},{0xdb,0xdb,0xe0},{0xe7,0xe7,0xe9},
        {0x00,0x00,0x00},{0x09,0x09,0x09},{0x0e,0x0e,0x0e},{0x15,0x14,0x15},
        {0x1e,0x1e,0x1e},{0x2a,0x2a,0x2a},{0x37,0x37,0x37},{0x48,0x48,0x48},
        {0x5c,0x5b,0x5c},{0x71,0x70,0x71},{0x89,0x88,0x89},{0xa1,0xa0,0xa1},
        {0xb6,0xb6,0xb6},{0xca,0xc9,0xca},{0xd9,0xd8,0xd9},{0xff,0xff,0xff}
    }};

    //  for (int i = 0; i < 256; ++i) {                 // ITERATE OVER COLUMNS
    //      palette[i] = {                              // ITERATE OVER ROWS
    //          static_cast<uint8_t>(i),                // R, btw mod 256 because it is 256 EXCLUSIVE, not 255 as that causes artifacts
    //          static_cast<uint8_t>(255 - i),          // G
    //          static_cast<uint8_t>(i / 2),            // B
    //      };
    //  }

    
    
    std::vector<uint8_t> framebuffer(width * height); // framebuffer

    for (unsigned y = 0; y < height; ++y) {
        for (unsigned x = 0; x < width; ++x) {
            uint8_t idx = x % 0xFF;                   // modulo 256 :3
            setpixel(x, y, framebuffer, width, idx);
        }
    }

    renderquad(50, 50, framebuffer, 50, 50, width, height, 2);
    renderquad(50, 250, framebuffer, 70, 70, width, height, 69);


    // this is the ACTUAL 4 byte buffer used for display :P

    std::vector<uint8_t> rgba(width * height * 4); 

    // not obvious conversion, framebuffer -> rgba

    for (unsigned y = 0; y < height; ++y) {                 // repeat over height of whole screen
        for (unsigned x = 0; x < width; ++x) {              // repeat over width of whole screen

            uint8_t index = framebuffer[y * width + x];     // index = (row offset * width + x offset), same as old code
            Color c = palette[index];                       // c has the r, g and b component,

            std::size_t i = (y * width + x) * 4;
            rgba[i + 0] = c.r;
            rgba[i + 1] = c.g;
            rgba[i + 2] = c.b;
            rgba[i + 3] = 255;
        }
    }

    // FIGURED OUT HOW TEXTURES WORK!!!
    // creates texture which fills the screen ofc
    sf::Texture texture({width, height});

    // upload pixels
    // i dont actually know what this fart does...
    

    sf::Sprite sprite(texture);

    while (window.isOpen()) {
        while (auto event = window.pollEvent()) {
            if (event->is<sf::Event::Closed>())
                window.close();
        }

        texture.update(rgba.data(), {width, height}, {0, 0});
        window.clear();
        window.draw(sprite);
        window.display();
    }
}
